<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dhn.client.push.mapper.SendRequest">

    <select id = "req_push_count" parameterType="com.dhn.client.bean.SQLParameter" resultType="int">
        select count(1) as cnt
        from ${msg_table}
        where STATUS = '100'
          and TYPE = '${msg_type}'
          and NVL(REQDTTM, CURRENT_TIMESTAMP) &lt;= CURRENT_TIMESTAMP
    </select>

    <update id = 'req_push_status_update' parameterType="com.dhn.client.bean.SQLParameter">
        UPDATE ${msg_table}
        SET STATUS = '101'
        WHERE ROWID IN (
            SELECT ROWID
            FROM (
                 SELECT ROWID
                 FROM ${msg_table}
                 WHERE STATUS = '100'
                   AND TYPE = '${msg_type}'
                   AND NVL(REQDTTM, CURRENT_TIMESTAMP) &lt;= CURRENT_TIMESTAMP
                 ORDER BY PRIORITY ASC
             )
            WHERE ROWNUM &lt;= 500
        )
    </update>

    <resultMap id="RequestTable" type="com.dhn.client.bean.PUSHRequestBean">
        <result column="SEQNO" property="msgid"/>
        <result column="TYPE" property="messagetype"/>
        <result column="MSG" property="msg"/>
        <result column="MSG_SMS" property="msgsms"/>
        <result column="DESTNO" property="phn"/>
        <result column="CALLBACK" property="smssender"/>
        <result column="BILLID" property="pinvoice"/>
        <result column="SMSKIND" property="smskind"/>
        <result column="TITLE" property="smslmstit"/>
        <result column="REGDT" property="regdt"/>
        <result column="KAKAO_CODE" property="tmplid"/>
        <result column="PROFILE_KEY" property="profile"/>
        <result column="REQDTTM" property="reservedt"/>
        <result column="PUSH_ID" property="pushid"/>
        <result column="APP_KEY" property="appkey"/>
        <result column="APP_SECRET" property="appsecret"/>
        <result column="APP_LINK" property="applink"/>
        <result column="ATCH_FILE_SN" property="atchfilesn"/>
        <result column="APP_LAUNCH" property="applaunch"/>
    </resultMap>

    <select id="req_push_select" parameterType = "com.dhn.client.bean.SQLParameter" resultMap = "RequestTable">
        SELECT
            SEQNO,
            'AP' as TYPE,
            MSG,
            MSG as MSG_SMS,
            CASE
                WHEN LENGTHB(MSG) &lt;= 90 THEN 'S'
                ELSE 'L'
                END AS SMSKIND,
            CASE
                WHEN DESTNO LIKE '82%' THEN DESTNO
                WHEN DESTNO LIKE '010%' THEN '82' || SUBSTR(DESTNO, 2, 15)
                ELSE '82' || SUBSTR(DESTNO, 2, 15)
                END AS DESTNO,
            CALLBACK,
            BILLID,
            TITLE,
            TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') AS REGDT,
            KAKAO_CODE,
            '${profile_key}' AS PROFILE_KEY,
            CASE
                WHEN REQDTTM IS NULL THEN '00000000000000'
                ELSE  TO_CHAR(REQDTTM, 'YYYYMMDDHH24MISS')
            END AS REQDTTM,
            PUSH_ID,
            APP_KEY,
            APP_SECRET,
            APP_LINK,
            ATCH_FILE_SN,
            APP_LAUNCH
        FROM ${msg_table}
        WHERE TYPE = '${msg_type}'
          and STATUS = '101'
    </select>

    <update id="req_push_sent_complet" parameterType="com.dhn.client.bean.SQLParameter">
        update ${msg_table}
        set STATUS = '102'
        where STATUS = '101'
          and TYPE = '${msg_type}'
    </update>

    <update id="req_push_sent_init" parameterType="com.dhn.client.bean.SQLParameter">
        update ${msg_table}
        set STATUS = '100'
        where STATUS = '101'
          and TYPE = '${msg_type}'
    </update>

</mapper>  