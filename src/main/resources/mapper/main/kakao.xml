<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dhn.client.kakao.mapper.SendRequest">
    <select id="req_kao_count" parameterType = "com.dhn.client.bean.SQLParameter" resultType = "int">
        select count(1) as cnt
        from ${msg_table}
        where RESULT in ('0','R')
            and (REQTIME = '00000000000000' OR REQTIME &lt;= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'))
            and SENTTIME is NULL
            and KIND in ('A','F')
            and RETRY = '0'
    </select>

    <update id="req_kao_group_update" parameterType = "com.dhn.client.bean.SQLParameter" >
        update ${msg_table}
        set RETRY = '${group_no}'
        where RESULT in ('0','R')
            and (REQTIME = '00000000000000' OR REQTIME &lt;= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'))
            and SENTTIME is NULL
            and KIND in ('A','F')
            and RETRY = '0'
            and ROWNUM &lt;= 1000
    </update>

    <resultMap id="RequestTable" type="com.dhn.client.bean.KAORequestBean">
        <result column="msg_id" property="msgid"/>
        <result column="message_type" property="messagetype"/>
        <result column="msg_txt" property="msg"/>
        <result column="sms_txt" property="msgsms"/>
        <result column="call_to" property="phn"/>
        <result column="call_from" property="smssender"/>
        <result column="pcom" property="pcom"/>
        <result column="userdata" property="pinvoice"/>
        <result column="msg_txt_title" property="smslmstit"/>
        <result column="crypto" property="crypto"/>
        <result column="curr_date" property="regdt"/>
        <result column="button" property="button"/>
        <result column="template_cd" property="tmplid"/>
        <result column="profile_key" property="profile"/>
        <result column="snd_dttm" property="reservedt"/>
    </resultMap>

    <select id="req_kao_select" parameterType = "com.dhn.client.bean.SQLParameter" resultMap = "RequestTable">
        select
            SEQNO as msg_id,
            (case
                when KIND = 'A' then 'AT'
                when KIND = 'F' then 'FT'
                else 'PH'
            end) as message_type,
            MSG as msg_txt,
            null as sms_txt,
            (case
                when CALLPHONE like '82%' then CALLPHONE
                when CALLPHONE like '010%' then '82' || substr(CALLPHONE,2,15)
                else '82' || substr(CALLPHONE,2,15)
            end) as call_to,
            REQPHONE as call_from,
            SUBJECT as msg_txt_title,
            'D' as pcom,
            'N' as crypto,
            K_ATTACH as button,
            to_char(sysdate, 'YYYY-MM-DD HH24:MI:SS') AS curr_date,
            BUTTON_NAME as btn_name,
            BUTTON_URL as btn_url,
            trim(TEMPLATECODE) as template_cd,
            (case when YELLOWID_KEY = '74cd69ab6e0066074e2da0f197409633b46efb5e' then
                'bfdb1b51fe4b29c3dc7e3f3d40fba90fb66bf858'
                else YELLOWID_KEY
            end) as profile_key,
            NVL(REQTIME, '00000000000000') AS snd_dttm
        from ${msg_table}
        where RESULT in ('0','R')
          and RETRY = '${group_no}'
          and KIND in ('A','F')
    </select>

    <update id="req_sent_complete" parameterType = "com.dhn.client.bean.SQLParameter" >
        update ${msg_table}
        set RESULT = '1',
            SENTTIME = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
        where RESULT in ('0','R')
            and RETRY = '${group_no}'
            and KIND in ('A','F')
    </update>

    <update id="req_sent_init" parameterType = "com.dhn.client.bean.SQLParameter" >
        update ${msg_table}
        set RESULT = '0',
            RETRY = '0',
            SENTTIME = NULL
        where RETRY = '${group_no}'
            and KIND in ('A','F')
    </update>
</mapper>
