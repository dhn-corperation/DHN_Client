<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dhn.client.nkakao.mapper.SendRequest">

    <select id="req_sms_count" parameterType = "com.dhn.client.bean.SQLParameter" resultType = "int">
        select count(1) as cnt
        fron ${msg_table}
        where RESULT in ('0','R')
            and (REQTIME = '00000000000000' OR REQTIME &lt;= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'))
            and SENTTIME is NULL
            and KIND = '${msg_type}'
            and GROUP_NO is NULL
    </select>

    <update id="req_sms_group_update" parameterType = "com.dhn.client.bean.SQLParameter" >
        update ${msg_table}
        set GROUP_NO = '${group_no}'
        where RESULT in ('0','R')
            and (REQTIME = '00000000000000' OR REQTIME &lt;= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'))
            and SENTTIME is NULL
            and KIND = '${msg_type}'
            and GROUP_NO is NULL
            and ROWNUM &lt; 1000
    </update>

    <select id="req_lms_count" parameterType = "com.dhn.client.bean.SQLParameter" resultType = "int">
        select count(1) as cnt
        from ${msg_table}
        where RESULT in ('0','R')
            and (REQTIME = '00000000000000' OR REQTIME &lt;= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'))
            and SENTTIME is NULL
            and KIND = '${msg_type}'
            and FKCONTENT is NULL
            and GROUP_NO is NULL
    </select>

    <update id="req_lms_group_update" parameterType = "com.dhn.client.bean.SQLParameter" >
        update ${msg_table}
        set GROUP_NO = '${group_no}'
        where RESULT in ('0','R')
            and (REQTIME = '00000000000000' OR REQTIME &lt;= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'))
            and SENTTIME is NULL
            and KIND = '${msg_type}'
            and FKCONTENT is NULL
            and GROUP_NO is NULL
            AND ROWNUM &lt;= 1000
    </update>

    <select id="req_mms_count" parameterType = "com.dhn.client.bean.SQLParameter" resultType = "int">
        select count(1) as cnt
        from ${msg_table}
        where RESULT in ('0','R')
            and (REQTIME = '00000000000000' OR REQTIME &lt;= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'))
            and SENTTIME is NULL
            and KIND = '${msg_type}'
            and GROUP_NO IS NULL
            and MMS_IMAGE_KEY is not null
    </select>

    <update id="req_mms_group_update" parameterType = "com.dhn.client.bean.SQLParameter" >
        update ${msg_table}
        set GROUP_NO = '${group_no}'
        where RESULT in ('0','R')
            and (REQTIME = '00000000000000' OR REQTIME &lt;= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'))
            and SENTTIME is NULL
            and KIND = '${msg_type}'
            and GROUP_NO is NULL
            and MMS_IMAGE_KEY is not null
            AND ROWNUM &lt;= 1000
    </update>

    <select id="req_mms_image_count" parameterType = "com.dhn.client.bean.SQLParameter" resultType="int">
        select count(1) as cnt
        from ${msg_table}
        where FKCONTENT is not null
            and MMS_IMAGE_KEY is null
    </select>

    <select id="req_mms_image" parameterType = "com.dhn.client.bean.SQLParameter" resultType = "com.dhn.client.bean.MMSImageBean">
        select msg.FKCONTENT as fkContent,
               img.FILEPATH1 as file1,
               img.FILEPATH2 as file2,
               img.FILEPATH3 as file3
        from ${msg_table} msg join ${img_table} img
            on msg.FKCONTENT = img.SEQNO
        where FKCONTENT is not null
            and MMS_IMAGE_KEY is null
    </select>

    <update id="req_mms_key_update" parameterType = "com.dhn.client.bean.SQLParameter" >
        update ${msg_table}
        set MMS_IMAGE_KEY = '${mms_key}'
        where FKCONTENT = '${fkContent}'
    </update>

    <resultMap id="RequestTable" type="com.dhn.client.bean.RequestBean">
        <result column="msg_id" property="msgid"/>
        <result column="message_type" property="messagetype"/>
        <result column="msg_txt" property="msg"/>
        <result column="sms_txt" property="msgsms"/>
        <result column="call_to" property="phn"/>
        <result column="call_from" property="smssender"/>
        <result column="pcom" property="pcom"/>
        <result column="mms_image_key" property="pinvoice"/>
        <result column="smskind" property="smskind"/>
        <result column="msg_txt_title" property="smslmstit"/>
        <result column="crypto" property="crypto"/>
        <result column="curr_date" property="regdt"/>
        <result column="snd_dttm" property="reservedt"/>
    </resultMap>

    <select id="req_sms_select" parameterType = "com.dhn.client.bean.SQLParameter" resultMap = "RequestTable">
        select
            SEQNO as msg_id,
            'PH' as message_type,
            MSG as msg_txt,
            MSG as sms_txt,
            CALLPHONE as call_to,
            REQPHONE as call_from,
            null as msg_txt_title,
            'S' as smskind,
            'D' as pcom,
            to_char(sysdate, 'YYYY-MM-DD HH24:MI:SS') AS curr_date,
            NVL(TO_CHAR(REQTIME, 'YYYYMMDDHH24MISS'), '00000000000000') AS snd_dttm
        from ${msg_table}
        WHERE RESULT = '0'
            and GROUP_NO = '${group_no}'
            and KIND = '${msg_type}'
    </select>

    <select id="req_lms_select" parameterType = "com.dhn.client.bean.SQLParameter" resultMap = "RequestTable">
        select
            SEQNO as msg_id,
            'PH' as message_type,
            MSG as msg_txt,
            MSG as sms_txt,
            CALLPHONE as call_to,
            REQPHONE as call_from,
            SUBJECT as msg_txt_title,
            'L' as smskind,
            'D' as pcom,
            to_char(sysdate, 'YYYY-MM-DD HH24:MI:SS') AS curr_date,
            NVL(TO_CHAR(REQTIME, 'YYYYMMDDHH24MISS'), '00000000000000') AS snd_dttm
        from ${msg_table}
        where RESULT = '0'
            and GROUP_NO = '${group_no}'
            and KIND = '${msg_type}'
            and FKCONTENT is NULL
    </select>

    <select id="req_mms_select" parameterType = "com.dhn.client.bean.SQLParameter" resultMap = "RequestTable">
        select
            SEQNO as msg_id,
            'PH' as message_type,
            MSG as msg_txt,
            MSG as sms_txt,
            CALLPHONE as call_to,
            REQPHONE as call_from,
            SUBJECT as msg_txt_title,
            'M' as smskind,
            'D' as pcom,
            to_char(sysdate, 'YYYY-MM-DD HH24:MI:SS') AS curr_date,
            NVL(TO_CHAR(REQTIME, 'YYYYMMDDHH24MISS'), '00000000000000') AS snd_dttm,
            mms_image_key
        from ${msg_table}
        where RESLT = '0'
          and GROUP_NO = '${group_no}'
          and KIND = '${msg_type}'
          and mms_image_key is not null
    </select>

    <update id="req_sent_complete" parameterType = "com.dhn.client.bean.SQLParameter" >
        update ${msg_table}
        set RESULT = '1',
            SENTTIME = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
        where RESULT = '0'
          and GROUP_NO = '${group_no}'
          and KIND = '${msg_type}'
    </update>

    <update id="req_sent_init" parameterType = "com.dhn.client.bean.SQLParameter" >

        update ${msg_table}
        set MSG_SNDG_STTS_CD = '0',
            GROUP_NO = NULL,
            SNDG_DDTI = NULL
        where
            MSG_SNDG_STTS_CD = '1'
          and GROUP_NO = '${group_no}'
          and MSG_DCD = '${msg_type}'
    </update>

    <update id="req_sent_init" parameterType = "com.dhn.client.bean.SQLParameter" >
        update ${msg_table}
        set RESULT = '0',
            GROUP_NO = NULL,
            SENTTIME = NULL
        where GROUP_NO = '${group_no}'
          and KIND = '${msg_type}'
    </update>

</mapper>