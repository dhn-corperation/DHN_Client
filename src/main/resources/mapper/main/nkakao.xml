<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dhn.client.nkakao.mapper.SendRequest">

    <select id="req_sms_count" parameterType = "com.dhn.client.bean.SQLParameter" resultType = "int">
        select count(1) as cnt
        from ${msg_table}
        where RESULT in ('0','R')
            and (REQTIME = '00000000000000' OR REQTIME &lt;= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'))
            and SENTTIME is NULL
            and KIND = '${msg_type}'
            and RETRY = '0'
    </select>

    <update id="req_sms_group_update" parameterType = "com.dhn.client.bean.SQLParameter" >
        update ${msg_table}
        set RETRY = '${group_no}'
        where RESULT in ('0','R')
            and (REQTIME = '00000000000000' OR REQTIME &lt;= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'))
            and SENTTIME is NULL
            and KIND = '${msg_type}'
            and RETRY = '0'
            and ROWNUM &lt;= 1000
    </update>

    <select id="req_lms_count" parameterType = "com.dhn.client.bean.SQLParameter" resultType = "int">
        select count(1) as cnt
        from ${msg_table}
        where RESULT in ('0','R')
            and (REQTIME = '00000000000000' OR REQTIME &lt;= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'))
            and SENTTIME is NULL
            and KIND = '${msg_type}'
            and FKCONTENT is NULL
            and RETRY = '0'
    </select>

    <update id="req_lms_group_update" parameterType = "com.dhn.client.bean.SQLParameter" >
        update ${msg_table}
        set RETRY = '${group_no}'
        where RESULT in ('0','R')
            and (REQTIME = '00000000000000' OR REQTIME &lt;= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'))
            and SENTTIME is NULL
            and KIND = '${msg_type}'
            and FKCONTENT is NULL
            and RETRY = '0'
            AND ROWNUM &lt;= 1000
    </update>

    <select id="req_mms_count" parameterType = "com.dhn.client.bean.SQLParameter" resultType = "int">
        select count(1) as cnt
        from ${msg_table}
        where RESULT in ('0','R')
            and (REQTIME = '00000000000000' OR REQTIME &lt;= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'))
            and SENTTIME is NULL
            and KIND = '${msg_type}'
            and RETRY = '0'
            and PSEQ is not null
    </select>

    <update id="req_mms_group_update" parameterType = "com.dhn.client.bean.SQLParameter" >
        update ${msg_table}
        set RETRY = '${group_no}'
        where RESULT in ('0','R')
            and (REQTIME = '00000000000000' OR REQTIME &lt;= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS'))
            and SENTTIME is NULL
            and KIND = '${msg_type}'
            and RETRY = '0'
            and PSEQ is not null
            AND ROWNUM &lt;= 1000
    </update>

    <select id="req_mms_image_count" parameterType = "com.dhn.client.bean.SQLParameter" resultType="int">
        select count(1) as cnt
        from ${msg_table}
        where FKCONTENT is not null
            and PSEQ is null
    </select>

    <select id="req_mms_image" parameterType = "com.dhn.client.bean.SQLParameter" resultType = "com.dhn.client.bean.MMSImageBean">
        select msg.SEQNO as msgid,
               msg.FKCONTENT as fkContent,
               img.FILEPATH1 as file1,
               img.FILEPATH2 as file2,
               img.FILEPATH3 as file3
        from ${msg_table} msg join ${img_table} img
            on msg.FKCONTENT = img.SEQNO
        where msg.FKCONTENT is not null
            and msg.PSEQ is null
            and msg.KIND = 'M'
    </select>

    <update id="req_mms_key_update" parameterType = "com.dhn.client.bean.SQLParameter" >
        update ${msg_table}
        set PSEQ = '${mms_key}'
        where FKCONTENT = '${fkContent}'
    </update>

    <resultMap id="RequestTable" type="com.dhn.client.bean.RequestBean">
        <result column="msg_id" property="msgid"/>
        <result column="message_type" property="messagetype"/>
        <result column="msg_txt" property="msg"/>
        <result column="sms_txt" property="msgsms"/>
        <result column="call_to" property="phn"/>
        <result column="call_from" property="smssender"/>
        <result column="pcom" property="pcom"/>
        <result column="mms_image_key" property="pinvoice"/>
        <result column="smskind" property="smskind"/>
        <result column="msg_txt_title" property="smslmstit"/>
        <result column="crypto" property="crypto"/>
        <result column="curr_date" property="regdt"/>
        <result column="snd_dttm" property="reservedt"/>
    </resultMap>

    <select id="req_sms_select" parameterType = "com.dhn.client.bean.SQLParameter" resultMap = "RequestTable">
        select
            SEQNO as msg_id,
            'PH' as message_type,
            MSG as msg_txt,
            MSG as sms_txt,
            CALLPHONE as call_to,
            REQPHONE as call_from,
            null as msg_txt_title,
            'S' as smskind,
            'D' as pcom,
            'N' as crypto,
            to_char(sysdate, 'YYYY-MM-DD HH24:MI:SS') AS curr_date,
            NVL(REQTIME, '00000000000000') AS snd_dttm
        from ${msg_table}
        WHERE RESULT in ('0','R')
            and RETRY = '${group_no}'
            and KIND = '${msg_type}'
    </select>

    <select id="req_lms_select" parameterType = "com.dhn.client.bean.SQLParameter" resultMap = "RequestTable">
        select
            SEQNO as msg_id,
            'PH' as message_type,
            MSG as msg_txt,
            MSG as sms_txt,
            CALLPHONE as call_to,
            REQPHONE as call_from,
            SUBJECT as msg_txt_title,
            'L' as smskind,
            'D' as pcom,
            'N' as crypto,
            to_char(sysdate, 'YYYY-MM-DD HH24:MI:SS') AS curr_date,
            NVL(REQTIME, '00000000000000') AS snd_dttm
        from ${msg_table}
        where RESULT in ('0','R')
            and RETRY = '${group_no}'
            and KIND = '${msg_type}'
            and FKCONTENT is NULL
    </select>

    <select id="req_mms_select" parameterType = "com.dhn.client.bean.SQLParameter" resultMap = "RequestTable">
        select
            SEQNO as msg_id,
            'PH' as message_type,
            MSG as msg_txt,
            MSG as sms_txt,
            CALLPHONE as call_to,
            REQPHONE as call_from,
            SUBJECT as msg_txt_title,
            'M' as smskind,
            'D' as pcom,
            'N' as crypto,
            to_char(sysdate, 'YYYY-MM-DD HH24:MI:SS') AS curr_date,
            NVL(REQTIME, '00000000000000') AS snd_dttm,
            PSEQ as mms_image_key
        from ${msg_table}
        where RESULT in ('0','R')
          and RETRY = '${group_no}'
          and KIND = '${msg_type}'
          and PSEQ is not null
    </select>

    <update id="req_sent_complete" parameterType = "com.dhn.client.bean.SQLParameter" >
        update ${msg_table}
        set RESULT = '1',
            SENTTIME = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
        where RESULT in ('0','R')
          and RETRY = '${group_no}'
          and KIND = '${msg_type}'
    </update>

    <update id="req_sent_init" parameterType = "com.dhn.client.bean.SQLParameter" >
        update ${msg_table}
        set RESULT = '0',
            RETRY = '0',
            SENTTIME = NULL
        where RETRY = '${group_no}'
          and KIND = '${msg_type}'
    </update>

    <resultMap id="LMSTable" type="com.dhn.client.bean.LMSTableBean">
        <result column="msgid" property="msg_id"/>
        <result column="intime" property="intime"/>
        <result column="usercode" property="usercode"/>
        <result column="reqname" property="reqname"/>
        <result column="reqphone" property="reqphone"/>
        <result column="callname" property="callname"/>
        <result column="callphone" property="callphone"/>
        <result column="msgtitle" property="msgtitle"/>
        <result column="msgtitle" property="msgtitle"/>
        <result column="msg" property="msg"/>
        <result column="msgsms" property="msgsms"/>
        <result column="smskind" property="smskind"/>
        <result column="mmskey" property="mmskey"/>
        <result column="deptcode" property="deptcode"/>
        <result column="seq_ex_ums" property="seq_ex_ums"/>
        <result column="empl_no" property="empl_no"/>
        <result column="reqid" property="reqid"/>
        <result column="smrseq" property="smrseq"/>
    </resultMap>

    <select id="kakao_to_sms_select" parameterType="com.dhn.client.bean.Msg_Log" resultMap="LMSTable">
        select SEQNO      as msgid,
               INTIME     as intime,
               USERCODE   as usercode,
               REQNAME    as reqname,
               REQPHONE   as reqphone,
               CALLNAME   as callname,
               CALLPHONE  as callphone,
               SUBJECT    as msgtitle,
               MSG        as msg,
               RETEXT     as msgsms,
               (case
                    when RESENTFLAG = '7' then 'S'
                    when RESENTFLAG in ('8', '9') then 'M'
                   end)   as smskind,
               FKCONTENT  as mmskey,
               DEPTCODE   as deptcode,
               SEQ_EX_UMS as seq_ex_ums,
               EMPL_NO    as empl_no,
               REQID      as reqid,
               SURE_MESSAGE_REQUEST_SEQ as smrseq
        from ${msg_table}
        where SEQNO = '${msgid}'
          and nvl(RESENTFLAG, '0') != '0'
    </select>

    <insert id="kao_to_sms_insert" parameterType="com.dhn.client.bean.LMSTableBean">
        insert into ${table} (
            SEQNO,
            INTIME,
            USERCODE,
            REQNAME,
            REQPHONE,
            CALLNAME,
            CALLPHONE,
            SUBJECT,
            MSG,
            KIND,
            FKCONTENT,
            DEPTCODE,
            SEQ_EX_UMS,
            EMPL_NO,
            REQID,
            SURE_MESSAGE_REQUEST_SEQ
             )
        values (
            ${table_seq}.nextval
            ,TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
            ,'${usercode}'
            ,'${reqname}'
            ,'${reqphone}'
            ,'${callname}'
            ,'${callphone}'
            ,'${msgtitle}'
            ,'${msgsms}'
            ,'${smskind}'
            ,'${mmskey}'
            ,'${deptcode}'
            ,'${seq_ex_ums}'
            ,'${empl_no}'
            ,'${reqid}'
            ,'${smrseq}'
             )
    </insert>

    <update id = "result_log_insert1" parameterType="com.dhn.client.bean.Msg_Log">
        update ${msg_table}
            set RECVTIME = TO_CHAR(TO_DATE('${result_time}', 'YYYY-MM-DD HH24:MI:SS'), 'YYYYMMDDHH24MISS'),
                ERRCODE = '${result}',
                RESULT = '${status}'
        where SEQNO = '${msgid}'
    </update>

    <insert id="result_log_insert2" parameterType="com.dhn.client.bean.SQLParameter">
        insert into ${log_table} select * from ${msg_table} where SEQNO = '${msgid}'
    </insert>

    <delete id="result_log_insert3" parameterType="com.dhn.client.bean.SQLParameter">
        delete from ${msg_table} where SEQNO = '${msgid}'
    </delete>

</mapper>